<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>QR 2 Term Project: Census Data – QR2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">QR2</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../syllabus.html"> 
<span class="menu-text">Syllabus &amp; policies</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../projects/Census/intro.html" aria-current="page"> 
<span class="menu-text">Course project</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#phase-1-initial-transcription" id="toc-phase-1-initial-transcription" class="nav-link" data-scroll-target="#phase-1-initial-transcription">Phase 1: Initial transcription</a></li>
  <li><a href="#phase-2-combining-and-cleaning" id="toc-phase-2-combining-and-cleaning" class="nav-link" data-scroll-target="#phase-2-combining-and-cleaning">Phase 2: Combining and Cleaning</a></li>
  <li><a href="#phase-3-data-summarization" id="toc-phase-3-data-summarization" class="nav-link" data-scroll-target="#phase-3-data-summarization">Phase 3: Data summarization</a></li>
  <li><a href="#phase-4-modeling" id="toc-phase-4-modeling" class="nav-link" data-scroll-target="#phase-4-modeling">Phase 4: Modeling</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">QR 2 Term Project: Census Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Note: The dates when the different stages of the project are due will be given by your instructor, and will likely differ somewhat from one instructor to another. Some instructors may use a different course project. Look to your instructor’s syllabus for guidance.</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The US Census is a decenial (that is, every ten years) enumeration of people living in the US and associated territories that is mandated by Article I section 2 of the US Constitution. Census data is published in widely available summary forms, e.g.&nbsp;the population of each state broken down by age and sex groups.</p>
<p>This project is about census data on the level of an individual person. For instance, in 2020, the census recorded information from about 330 million persons. This person-by-person data is held confidential for 70 years after the census is conducted. After that, it become available to any interested party. The most recent census with such <em>microdata</em> available is 1950. This project concerns the 1940 census.</p>
<p>Your work on this project will be conducted in several phases. Instructions for each will be given and a (short) report will be required about your progress after each phase. The first phase, “initial transcription,” has several steps, the goal being to put the data pertaining to one “population schedule” into machine readable form</p>
<section id="phase-1-initial-transcription" class="level3 no-number">
<h3 class="no-number anchored" data-anchor-id="phase-1-initial-transcription">Phase 1: Initial transcription</h3>
<section id="step-1" class="level4 no-number">
<h4 class="no-number anchored" data-anchor-id="step-1">STEP 1:</h4>
<p>You will select a single document called a “Population Schedule” which gives the data collected on each of roughly 30 to 40 people. The 1940 Census involved about 4 million such schedules, but we will focus on the hundreds from Travis County, TX. A large collection of images of the schedules is available, as well as the <a href="https://www.archives.gov/research/census/1940/research/census/1940/general-info#form">codebook</a> for the schedules.</p>
<ol type="a">
<li><p><a href="https://catalog.archives.gov/search-within/57229197">This site</a> contains an archive of the Travis County population schedules. The archive is organized into a list of about 100 distinct “enumeration districts,” each with a title like “1940 Census Population Schedules - Texas - Travis County - ED 227-84.”</p></li>
<li><p>Pick one of the hundred at random.[^NOTE: If you are from Travis County or have a location of interest to you personally such as your family’s or your grandparents’ home, you might want to pick the corresponding population schedule. But avoid landmarks such as the Capitol that many students would be tempted to pick.] One possibility, select a district whose number ends with the day of them month you were born, plus 4 times the month you were born. (For instance, if your birthday is Feb 28, your “random” number is 28 + 4 <span class="math inline">\(\times\)</span> 2, pointing to ED 227-36.</p></li>
<li><p>Navigate to the ED you picked in (b). For instance, our Feb 28 student will go to ED 227-36 where she will find 38 population schedules. Pick one at random, but try to avoid schedules that don’t have almost all rows filled in.</p></li>
<li><p>Download the JPG image for your population schedule to your laptop or another convenient location.</p></li>
</ol>
</section>
<section id="step-2" class="level4 no-number">
<h4 class="no-number anchored" data-anchor-id="step-2">STEP 2</h4>
<p>Register your population schedule on <a href="https://docs.google.com/spreadsheets/d/1SHIPF96TzNPFmJqbp3x1p2nKv3hHZDNgLSQLj2hXzwI/edit?usp=sharing">this spreadsheet</a>. We will all share this Population Schedule Registrar, each of us being responsible for one row.</p>
<ol type="i">
<li><p>The unit of observation is one population schedule. (Typically covering about 40 people.)</p></li>
<li><p>There is an example entry on line 2. Follow that pattern when entering your own sheet.</p>
<ol type="a">
<li>We’ll find the latitude and longitude at the heart of your schedule later. Following professional practice, enter the latitude and longitude as “NA,” a common signifier for “missing data.”</li>
<li>The <code>ED_sheet_count</code> is not about your particular sheet, but about the ED from which you selected your particular sheet. It is the number of sheets (indicated on the ED page) from which you selected one.</li>
<li>The <code>person_sheet</code> and <code>household_sheet</code> will be filled in as part of STEP 3.</li>
</ol></li>
</ol>
</section>
<section id="step-3" class="level4 no-number">
<h4 class="no-number anchored" data-anchor-id="step-3">STEP 3</h4>
<ol type="1">
<li>Create TWO google sheet documents where you will enter the data from your population schedule.
<ol type="a">
<li>One sheet will have “a person” as the unit of observation.</li>
<li>The second sheet will have “a household” as the unit of observation.</li>
</ol></li>
</ol>
<p>If you are not sure how to do this, ask a friend or search online.</p>
<ol start="2" type="1">
<li>Arrange via Google sheets to “share” your sheets with anyone with the links. Copy the links into the <code>person_sheet</code> and <code>household_sheet</code> columns in the Population Schedule Register (STEP 2).</li>
</ol>
</section>
<section id="step-4" class="level4 no-number">
<h4 class="no-number anchored" data-anchor-id="step-4">STEP 4</h4>
<p>Figure out how you can display your population schedule so that you can readily read from it. If you have a large external monitor, you might find that sufficient. If not, consider printing out the schedule at a sufficient resolution that you can read the entries. Unless you have very sharp eyes, or a magnifying glass, you will need more than one page to print the whole image.</p>
<p>In STEP 6 you will start to transcribe data from the schedule into your STEP 3 Google spreadsheets. A laptop display may be sufficient for this. Arrange your desk/displays so that you can easily read from the image while typing in the spreadsheet.</p>
</section>
<section id="step-5" class="level4 no-number">
<h4 class="no-number anchored" data-anchor-id="step-5">STEP 5</h4>
<p>THINK about what you want to call your variables and how you want to encode them. Feel free to talk to your classmates or even work together in doing this. It’s a good idea to create yet another sharable document that you use as your codebook giving the meaning of the variable names and specifying the levels of any categorical variables and the units of any quantitative ones. (Some of the schedule entries don’t have a ixed set of levels, for instance, the person’s name. You don’t have to specify those in your codebook, but you might want to set the format, e.g., “surname, first middle, with CAPITALS as written on the schedule.”)</p>
<p>The “person” and “household” spreadsheets will presumably have different variables. Also, since every person is a member of a “household” (even if it is of size 1), you will add a household ID for each household and enter the corresponding ID as a variable in the person spreadsheet.</p>
</section>
<section id="step-6" class="level4 no-number">
<h4 class="no-number anchored" data-anchor-id="step-6">STEP 6</h4>
<p>Transcribe your schedule into your person and household spreadsheets. Add a new variable to each of these spreadsheets: the ID of the population schedule from which you transcribed the data. This will be the same for all rows (that is, <strong>no</strong> variation). In Phase 2 you will see why this has been added.</p>
<p>In addition, you will figure out an reasonable <code>latitude</code> and <code>longitude</code> for your population schedule and enter this into our shared <a href="https://docs.google.com/spreadsheets/d/1SHIPF96TzNPFmJqbp3x1p2nKv3hHZDNgLSQLj2hXzwI/edit?usp=sharing">Population Schedule Registry</a></p>
</section>
</section>
<section id="phase-2-combining-and-cleaning" class="level3 no-number">
<h3 class="no-number anchored" data-anchor-id="phase-2-combining-and-cleaning">Phase 2: Combining and Cleaning</h3>
<p>To streamline this phase, we will work as a class to standardize the format of the spreadsheets and to identify errors. Disregard the earlier instructions for this phase. Instead, refer to the <a href="spreadsheet-checklist.html">spreadsheet checklist</a>.</p>
<!-- In this phase, you will work with a team of two or three classmates. Your team will  combine your spreadsheets into new, team documents that contain the entries for your three or four population schedules. (Keep your original, individual spreadsheets!) The team sheets will have roughly 100 persons and about 20 households.

In the process of combining your spreadsheets you are likely to encounter errors in your initial data entry or situations where data was entered in incompatible ways by different people in the team. Fixing such problems is an example of "data cleaning."

To facilitate identifying problems, your instructor will show you how to read your data into R so that you can wrangle summaries that point to inconsistencies. You don't need to do this on your own; your instructor will help.

Once all teams have completed combining and cleaning their team sheets, we will as a class discuss inconsistencies between teams and reconcile them. Be prepared to do additional cleaning of your team sheets.

-->
</section>
<section id="phase-3-data-summarization" class="level3">
<h3 class="anchored" data-anchor-id="phase-3-data-summarization">Phase 3: Data summarization</h3>
<p>Using grit, hard work, computing savvy, and magic, a heroic instructor will combine the various team spreadsheets into new, comprehensive sheets that encompass several hundred 1940 persons and a hundred or so households.</p>
<p>You may well get feedback from the hero-instructor about edits you should make to your team’s sheets. This is why you added a population schedule ID to every row of your individual spreadsheet, so that the instructor can figure out who is responsible for making the change. Please respond in a timely way so that all of us can move on.</p>
<p>Your primary task—you, as an individual student—in Phase 3 is to create simple summaries of the combined data in tabular and/or graphical form. For instance, how many 1940 persons fall into the various household “roles” of head, spouse, child, lodger, etc. You will make several such summaries for your Phase 3 report. Be creative. Your instructor can help you to write the data wrangling commands needed.</p>
</section>
<section id="phase-4-modeling" class="level3">
<h3 class="anchored" data-anchor-id="phase-4-modeling">Phase 4: Modeling</h3>
<p>You will choose a demographic/statistical/etc question of interest to you and carry out the data wrangling and modeling needed to make definite statements about the question. As an example, a person interested in housing affordability might model whether owning or renting a house is related to explanatory variables such as farm-vs-city, size of household, income of household, and so on.</p>
<p>Your report will include not just the statistical analysis but also interpretation and supporting summaries. For the housing affordability example, it would be appropriate for instance to make a map showing housing costs as a function of geographic position to identify well- and poorly-housed areas of Travis County in 1940.</p>
<p>You will submit your written report and also give a short (3- to 5-minute) presentation in class. You are welcome to work with your student colleagues, but your model, report, and presentation will be your individual product.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>